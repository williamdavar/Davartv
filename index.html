<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Davar TV - Señal de Bendición</title>
    <!-- Tailwind CSS: Estética provista por la Jerarquía Mayor -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React y ReactDOM para la interfaz viva -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel para procesar la lógica -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- FIREBASE COMPAT: Conexión estable con el Creador -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .mask-fade-top {
            mask-image: linear-gradient(to top, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to top, black 85%, transparent 100%);
        }
        @keyframes pulse-live {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.02); }
        }
        .animate-live { animation: pulse-live 2s infinite; }
    </style>
</head>
<body class="bg-black text-white antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Fragment } = React;

        // --- COMPONENTES DE ICONOS SVG SEGUROS ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                tv: <path d="M7 21h10M12 21v-4M2 7a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7z" />,
                radio: <path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5M12 12c.6 0 1-.4 1-1s-.4-1-1-1-1 .4-1 1 .4 1 1 1zM16.2 4.9c3.9 3.9 3.9 10.3 0 14.2M19.1 7.8c2.3 2.3 2.3 6.1 0 8.5" />,
                settings: (
                    <Fragment>
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </Fragment>
                ),
                share: <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13" />,
                send: <Fragment><path d="m22 2-7 20-4-9-9-4Z" /><path d="M22 2 11 13" /></Fragment>,
                lock: <Fragment><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></Fragment>,
                x: <path d="M18 6 6 18M6 6l12 12" />,
                zap: <path d="m13 2-9 11h7l-1 9 9-11h-7z" />,
                heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
            };

            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'davar-tv-app';
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (!window.firebase.apps.length) window.firebase.initializeApp(firebaseConfig);
        const db = window.firebase.firestore();
        const auth = window.firebase.auth();

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('feed'); 
            const [mainSignal, setMainSignal] = useState(null);
            const [chatMessages, setChatMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [toast, setToast] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [pass, setPass] = useState('');
            
            const chatEndRef = useRef(null);

            // 1. Efecto de Autenticación Robusta
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (authToken) {
                            await auth.signInWithCustomToken(authToken);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) { 
                        console.error("Auth Error:", e);
                        setToast("Error de conexión celestial");
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    if (u) setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // 2. Efecto de Escucha de Datos (Solo tras Autenticación)
            useEffect(() => {
                if (!user) return;
                
                // Señal: 6 segmentos (artifacts/{id}/public/data/signals/main)
                const signalPath = `artifacts/${appId}/public/data/signals/main`;
                const unsubSignal = db.doc(signalPath).onSnapshot((snap) => {
                    setMainSignal(snap && snap.exists ? snap.data() : null);
                }, (error) => {
                    console.error("Signal Permission Error:", error);
                });

                // Chat: 5 segmentos (artifacts/{id}/public/data/global_chat)
                const chatPath = `artifacts/${appId}/public/data/global_chat`;
                const unsubChat = db.collection(chatPath)
                    .orderBy('timestamp', 'desc').limit(25)
                    .onSnapshot((snap) => {
                        setChatMessages(snap.docs.map(d => ({ id: d.id, ...d.data() })).reverse());
                        setTimeout(() => chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                    }, (error) => {
                        console.error("Chat Permission Error:", error);
                    });

                return () => { unsubSignal(); unsubChat(); };
            }, [user]);

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!newMessage.trim() || !user) return;
                const chatPath = `artifacts/${appId}/public/data/global_chat`;
                try {
                    await db.collection(chatPath).add({
                        text: String(newMessage), 
                        sender: user.uid, 
                        timestamp: window.firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setNewMessage('');
                } catch (e) {
                    setToast("No se pudo enviar el mensaje");
                }
            };

            const toggleSignal = async () => {
                const signalRef = db.doc(`artifacts/${appId}/public/data/signals/main`);
                try {
                    if (mainSignal?.active) {
                        await signalRef.delete();
                    } else {
                        await signalRef.set({ active: true, startTime: window.firebase.firestore.FieldValue.serverTimestamp() });
                    }
                } catch (e) {
                    setToast("Error al modificar la señal");
                }
            };

            if (!user) return (
                <div className="h-screen bg-black flex flex-col items-center justify-center space-y-4">
                    <div className="w-12 h-12 border-2 border-red-600 border-t-transparent rounded-full animate-spin"></div>
                    <p className="font-black italic text-xs tracking-widest text-red-600 animate-pulse uppercase">Conectando con el Trono...</p>
                </div>
            );

            return (
                <div className="min-h-screen max-w-md mx-auto bg-black flex flex-col border-x border-white/10 shadow-2xl relative overflow-hidden">
                    {/* Header */}
                    <header className="p-4 border-b border-white/5 bg-black/80 backdrop-blur-md flex justify-between items-center sticky top-0 z-50">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('feed')}>
                            <span className="text-xl font-black italic tracking-tighter">Davar TV</span>
                            {mainSignal?.active && <div className="bg-red-600 px-2 py-0.5 rounded text-[8px] font-black animate-pulse uppercase">LIVE</div>}
                        </div>
                        <button onClick={() => setView(view === 'admin' ? 'feed' : 'admin')} className={isAdmin ? 'text-red-500' : 'text-white/40'}>
                            <Icon name="settings" size={20} />
                        </button>
                    </header>

                    <main className="flex-1 overflow-y-auto no-scrollbar">
                        {view === 'feed' && (
                            <div className="flex flex-col animate-in fade-in duration-500">
                                <div className="aspect-[4/5] bg-neutral-900 flex items-center justify-center relative overflow-hidden shadow-inner" onClick={() => mainSignal?.active && setView('viewer')}>
                                    {mainSignal?.active ? (
                                        <div className="text-center z-10">
                                            <Icon name="radio" size={80} className="text-red-600 animate-live mx-auto" />
                                            <h3 className="mt-4 font-black italic text-lg uppercase tracking-widest">Señal Activa</h3>
                                            <p className="text-[10px] text-white/40 uppercase tracking-[0.2em] mt-1">Jehová Jireh Provee</p>
                                        </div>
                                    ) : (
                                        <div className="text-center opacity-20"><Icon name="tv" size={64} className="mx-auto" /><p className="text-[10px] font-black uppercase mt-4 tracking-widest">Fuera del Aire</p></div>
                                    )}
                                    <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black/40 pointer-events-none"></div>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div className="flex gap-6 items-center">
                                        <Icon name="heart" size={28} className="text-white/20" />
                                        <button onClick={() => mainSignal?.active && setView('viewer')}><Icon name="message" size={28} /></button>
                                        <button onClick={() => { navigator.clipboard.writeText(window.location.href); setToast("¡Copiado!"); setTimeout(()=>setToast(null), 2000); }}><Icon name="share" size={28} /></button>
                                    </div>
                                    <div className="space-y-1">
                                        <p className="text-sm font-black italic uppercase text-red-500">Davar TV Oficial</p>
                                        <p className="text-xs text-white/40 leading-relaxed italic">Conectados en un mismo espíritu para la gloria de Dios.</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'admin' && (
                            <div className="flex-1 flex flex-col items-center justify-center p-10 h-full bg-neutral-950">
                                {!isAdmin ? (
                                    <Fragment>
                                        <Icon name="lock" size={48} className="text-red-600 mb-8" />
                                        <input type="password" value={pass} onChange={e => setPass(e.target.value)} placeholder="Clave" className="w-full bg-white/5 border border-white/10 rounded-2xl p-5 text-center text-3xl tracking-[0.5em] mb-8 outline-none focus:ring-1 focus:ring-red-600" autoFocus />
                                        <button onClick={() => pass === '1234' ? setIsAdmin(true) : setToast("Error")} className="w-full bg-red-600 p-5 rounded-2xl font-black text-xs uppercase tracking-widest">Entrar al Estudio</button>
                                        <button onClick={() => setView('feed')} className="mt-6 text-[10px] font-bold text-white/20 uppercase">Volver</button>
                                    </Fragment>
                                ) : (
                                    <div className="text-center space-y-8 w-full">
                                        <h2 className="font-black italic text-xl uppercase tracking-tighter">Consola de Emisión</h2>
                                        <button onClick={toggleSignal} className={`w-full p-8 rounded-3xl font-black text-sm uppercase tracking-widest shadow-2xl transition-all ${mainSignal?.active ? 'bg-red-600 shadow-red-900/40' : 'bg-green-600 shadow-green-900/20'}`}>
                                            {mainSignal?.active ? "Cerrar Señal" : "Iniciar Transmisión"}
                                        </button>
                                        <button onClick={() => setView('feed')} className="text-[10px] font-bold text-white/20 uppercase tracking-widest underline decoration-red-600 underline-offset-4">Regresar al Muro</button>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'viewer' && (
                            <div className="flex-1 flex flex-col h-full bg-black animate-in slide-in-from-right duration-300">
                                <div className="flex-1 flex items-center justify-center opacity-5 pointer-events-none"><Icon name="radio" size={180} className="text-red-600 animate-live" /></div>
                                <div className="absolute inset-0 flex flex-col bg-gradient-to-t from-black via-black/20 to-black/80">
                                    <div className="p-6 flex justify-between items-center">
                                        <div className="flex items-center gap-2">
                                            <div className="bg-red-600 px-3 py-1 rounded-full text-[9px] font-black uppercase shadow-lg">En Vivo</div>
                                            <div className="bg-black/50 backdrop-blur-md px-4 py-1.5 rounded-full text-[10px] font-bold border border-white/10 italic">Comunidad Davar</div>
                                        </div>
                                        <button onClick={() => setView('feed')} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors"><Icon name="x" size={20} /></button>
                                    </div>
                                    <div className="flex-1"></div>
                                    <div className="h-[30rem] flex flex-col p-6 bg-gradient-to-t from-black via-black/95 to-transparent">
                                        <div className="flex-1 overflow-y-auto space-y-4 no-scrollbar mask-fade-top pr-2">
                                            {chatMessages.length === 0 ? (
                                                <div className="h-full flex flex-col items-center justify-center opacity-10 italic"><p className="text-[10px] font-black uppercase tracking-[0.3em]">Yahweh Shammah</p></div>
                                            ) : (
                                                chatMessages.map(m => (
                                                    <div key={m.id} className="flex gap-4 animate-in slide-in-from-left duration-200">
                                                        <div className="w-8 h-8 rounded-full bg-neutral-800 flex items-center justify-center text-[10px] font-black text-white/20 border border-white/5 shadow-lg shrink-0">H</div>
                                                        <div className="flex-1">
                                                            <div className="bg-white/5 backdrop-blur-xl border border-white/10 p-4 rounded-2xl rounded-tl-none text-[15px] leading-relaxed text-white shadow-xl">
                                                                <span className="text-[9px] text-red-500 font-black block mb-1 uppercase tracking-widest opacity-60 italic">Hno</span>
                                                                {m.text}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                            <div ref={chatEndRef} />
                                        </div>
                                        <form onSubmit={sendMessage} className="mt-8 flex gap-4">
                                            <input type="text" value={newMessage} onChange={e => setNewMessage(e.target.value)} placeholder="Compartir..." className="flex-1 bg-white/5 border border-white/10 rounded-full px-7 py-5 outline-none focus:ring-1 focus:ring-red-600 text-sm shadow-inner" />
                                            <button type="submit" className="bg-white text-black p-5 rounded-full shadow-2xl active:scale-90 transition-transform"><Icon name="send" size={24} /></button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Nav Bar */}
                    <nav className="h-20 border-t border-white/5 flex items-center justify-around bg-black/95 backdrop-blur-3xl sticky bottom-0 z-50">
                        <button onClick={() => setView('feed')} className={view === 'feed' ? 'text-white shadow-lg' : 'text-white/20'}><Icon name="tv" size={26} /></button>
                        <div onClick={() => setView('admin')} className="w-16 h-11 rounded-2xl border border-white/10 flex items-center justify-center cursor-pointer hover:bg-white/5 transition-all group">
                            <div className={`w-3 h-3 rounded-full ${mainSignal?.active ? 'bg-red-600 animate-pulse shadow-[0_0_20px_rgba(220,38,38,0.7)]' : 'bg-white/10 group-hover:bg-white/30'}`}></div>
                        </div>
                        <div className="text-white/5"><Icon name="heart" size={26} /></div>
                    </nav>

                    {toast && (
                        <div className="fixed top-24 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-10 py-5 rounded-full font-black text-[10px] z-[200] animate-bounce shadow-2xl uppercase tracking-widest tracking-tighter flex items-center gap-3"><Icon name="zap" size={16} /> {toast}</div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
